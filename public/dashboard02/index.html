<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Dashboard</title>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<link rel="shortcut icon" href="./assets/logo.png">
	<link rel="stylesheet" type="text/css" href="css/style.css">
	<style>
		.chart-container {
			width: 80%;
			margin: 50px auto;
		}
	
	
	</style>
</head>

<body onload="chamafuncoes()">
	<script data-jsd-embedded data-key="fd5fd562-8848-4c99-842c-c1325101f6b6" 
	data-base-url="https://jsd-widget.atlassian.com" 
	src="https://jsd-widget.atlassian.com/assets/embed.js"></script>


	<div class="container">
		<div id="alert-container" style="position: fixed; top: 10px; right: 10px; z-index: 1000;"></div>
		<nav class="navigation">
			<ul>
				<li>
					<a href="#">
						<img class="logo" src="img/logo.svg" alt="">
					</a>
				</li>
				<li>
					<a href="#">
						<span class="icon"><ion-icon name="stats-chart-outline"></ion-icon></span>
						<span class="title">Dashboard</span>
					</a>
				</li>

				<li>
					<a href="#">
						<span class="icon"><ion-icon name="help-outline"></ion-icon></span>
						<span class="title">Suporte Tecnico</span>
					</a>
				</li>
				<li>
					<a href="#">
						<span class="icon"><ion-icon name="settings-outline"></ion-icon></span>
						<span class="title">Configurações</span>
					</a>
				</li>
				</li>
				<li>
					<a href="../homeDashboard.html">
						<span class="icon"><ion-icon name="log-out-outline"></ion-icon> </span>
						<span class="title">Sair</span>
					</a>

				</li>
			</ul>
		</nav>

		<div class="main">
			<div class="topbar" onclick="mudaUmidade()">
				<div class="toggle">
					<ion-icon name="menu-outline"></ion-icon>
				</div>



				<div class="user">
					<img src="img/person-circle-outline.svg">
				</div>

			</div>


			<div class="cardBox">
				<div class="card">
					<div>
						<div class="numbers" id="mostra_temperaturaAtual">20ºC</div>
						<div class="cardName">Temperatura Atual</div>
					</div>
					<div class="iconBx">
						<ion-icon name="thermometer-outline"></ion-icon>
					</div>
				</div>
			</div>

			<div class="cardBox">
				<div class="card">
					<div>
						<div class="numbers" id="mostra_umidade">20%</div>
						<div class="cardName">Umidade Atual</div>
					</div>
					<div class="iconBx">
						<ion-icon name="water-outline"></ion-icon>
					</div>
				</div>
			</div>

			<div class="cardBox">
				<div class="card">
					<div>
						<div class="numbers">20ºC</div>
						<div class="cardName">Temperatura Ideal</div>
					</div>
					<div class="iconBx">
						<ion-icon name="thermometer-outline"></ion-icon>
					</div>
				</div>
			</div>

			<div class="cardBox">
				<div class="card">
					<div>
						<div class="numbers">11% á 12%</div>
						<div class="cardName">Umidade Ideal</div>
					</div>
					<div class="iconBx">
						<ion-icon name="water-outline"></ion-icon>
					</div>
				</div>
			</div>
			
			<!-- Adicione os elementos canvas aqui -->
			<div class="chart-container">
				<canvas id="temperaturaChart"></canvas>
			</div>
			
			<div class="chart-container">
				<canvas id="umidadeChart"></canvas>
			</div>
			

			<div class="span_historic">
				<Span>Historico de Temperatura</Span>
				<span class="icon"><ion-icon size="large" name="reader-outline" style="color: #6F4026;"></span>
			</div>

			<div class="historic">

				<div class="column">Data</div>
				<div class="column">Hora</div>
				<div class="column">Temperatura</div>
				<div class="column">Status</div>

				<div class="row">
					<div class="cell">08/05/2024</div>
					<div class="cell">12:09PM</div>
					<div class="cell">20ºC</div>
					<div class="cell">Bom</div>
				</div>
				<div class="row">
					<div class="cell">08/05/2024</div>
					<div class="cell">12:09PM</div>
					<div class="cell">19ºC</div>
					<div class="cell">Bom</div>
				</div>
				<div class="row">
					<div class="cell">08/05/2024</div>
					<div class="cell">12:09PM</div>
					<div class="cell">20ºC</div>
					<div class="cell">Bom</div>
				</div>
				<div class="row">
					<div class="cell">08/05/2024</div>
					<div class="cell">12:09PM</div>
					<div class="cell">20ºC</div>
					<div class="cell">Bom</div>
				</div>
				<div class="row">
					<div class="cell">08/05/2024</div>
					<div class="cell">12:09PM</div>
					<div class="cell">22ºC</div>
					<div class="cell">Ruim</div>
				</div>
			</div>

			<div class="span_historic">
				<Span>Historico de Umidade</Span>
				<span class="icon"><ion-icon size="large" name="reader-outline" style="color: #6F4026;"></span>
			</div>

			<div class="historic">

				<div class="cell">08/05/2024</div>
				<div class="cell">12:09PM</div>
				<div class="cell">65%</div>
				<div class="cell">Bom</div>

				<div class="row">
					<div class="cell">08/05/2024</div>
					<div class="cell">12:09PM</div>
					<div class="cell">63%</div>
					<div class="cell">Bom</div>
				</div>
				<div class="row">
					<div class="cell">08/05/2024</div>
					<div class="cell">12:09PM</div>
					<div class="cell">65%</div>
					<div class="cell">Bom</div>
				</div>
				<div class="row">
					<div class="cell">08/05/2024</div>
					<div class="cell">12:09PM</div>
					<div class="cell">65%</div>
					<div class="cell">Bom</div>
				</div>
				<div class="row">
					<div class="cell">08/05/2024</div>
					<div class="cell">12:09PM</div>
					<div class="cell">70%</div>
					<div class="cell">Ruim</div>
				</div>
				<div class="row">
					<div class="cell">08/05/2024</div>
					<div class="cell">12:09PM</div>
					<div class="cell">80%</div>
					<div class="cell">Ruim</div>
				</div>
			</div>



		</div>

	</div>



	<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
	<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

	<script>
		// MenuToggle
		let toggle = document.querySelector('.toggle');
		let navigation = document.querySelector('.navigation');
		let main = document.querySelector('.main');

		toggle.onclick = function () {
			navigation.classList.toggle('active');
			main.classList.toggle('active')
		}

		// add hovered class in selected list item
		let list = document.querySelectorAll('.navigation li');
		function activeLink() {
			list.forEach((item) =>
				item.classList.remove('hovered'));
			this.classList.add('hovered')
		}
		list.forEach((item) =>
			item.addEventListener('mouseover', activeLink));

	</script>

</body>

</html>
<script>
	let dadosTemperatura = {
	  labels: [],
	  data: [],
	};
	
	let dadosUmidade = {
	  labels: [],
	  data: [],
	};
	
	let temperaturaChart = null;
	let umidadeChart = null;
	
	function inicializarGraficosComDadosIniciais(dados) {
	  console.log("Inicializando gráficos com dados iniciais:", dados);
	  const dadosIniciais = dados.filter(item => item.temperatura !== '0.00' && item.umidade !== '0.00').slice(-10);
	
	  dadosIniciais.forEach(item => {
		dadosTemperatura.labels.push(item.data_hora);
		dadosTemperatura.data.push(item.temperatura);
		dadosUmidade.labels.push(item.data_hora);
		dadosUmidade.data.push(item.umidade);
	  });
	
	  criarGraficos();
	}
	
	function atualizarGraficoComNovosDados(dados) {
	  console.log("Atualizando gráficos com novos dados:", dados);
	  const novaCaptura = dados.findLast(item => item.temperatura !== '0.00' && item.umidade !== '0.00');
	  if (novaCaptura) {
		dadosTemperatura.labels.push(novaCaptura.data_hora);
		dadosTemperatura.data.push(novaCaptura.temperatura);
		dadosUmidade.labels.push(novaCaptura.data_hora);
		dadosUmidade.data.push(novaCaptura.umidade);
	
		if (dadosTemperatura.labels.length > 10) {
		  dadosTemperatura.labels.shift();
		  dadosTemperatura.data.shift();
		  dadosUmidade.labels.shift();
		  dadosUmidade.data.shift();
		}
	
		temperaturaChart.data.labels = dadosTemperatura.labels;
		temperaturaChart.data.datasets[0].data = dadosTemperatura.data;
		temperaturaChart.update();
	
		umidadeChart.data.labels = dadosUmidade.labels;
		umidadeChart.data.datasets[0].data = dadosUmidade.data;
		umidadeChart.update();
	
		mudaTemperatura();
		mudaUmidade();
	  }
	}
	
	function buscarDadosEMostrarGraficos(armazemId) {
	  fetch(`/medidas/monitoramento/${armazemId}`, {
		method: "GET",
		headers: {
		  "Content-Type": "application/json",
		},
	  })
	  .then(function (resposta) {
		if (!resposta.ok) {
		  throw new Error("Erro ao obter os dados de monitoramento.");
		}
		return resposta.json();
	  })
	  .then(function (dados) {
		console.log("Dados recebidos do servidor:", dados);
		if (!temperaturaChart || !umidadeChart) {
		  inicializarGraficosComDadosIniciais(dados);
		} else {
		  atualizarGraficoComNovosDados(dados);
		}
	  })
	  .catch(function (erro) {
		console.error("Erro ao obter os dados de monitoramento: ", erro);
	  });
	}
	
	function criarGraficos() {
	  const contextoTemperatura = document.getElementById('temperaturaChart').getContext('2d');
	  const contextoUmidade = document.getElementById('umidadeChart').getContext('2d');
	
	  temperaturaChart = new Chart(contextoTemperatura, {
		type: 'line',
		data: {
		  labels: dadosTemperatura.labels,
		  datasets: [{
			label: 'Temperatura (ºC)',
			backgroundColor: 'rgba(255, 99, 132, 0.2)',
			borderColor: 'rgba(255, 99, 132, 1)',
			data: dadosTemperatura.data,
			fill: false,
		  }]
		},
		options: {
		  responsive: true,
		  scales: {
			x: {
			  display: true,
			  title: {
				display: true,
				text: 'Data e Hora'
			  }
			},
			y: {
			  display: true,
			  title: {
				display: true,
				text: 'Temperatura (ºC)'
			  }
			}
		  }
		}
	  });
	
	  umidadeChart = new Chart(contextoUmidade, {
		type: 'line',
		data: {
		  labels: dadosUmidade.labels,
		  datasets: [{
			label: 'Umidade (%)',
			backgroundColor: 'rgba(54, 162, 235, 0.2)',
			borderColor: 'rgba(54, 162, 235, 1)',
			data: dadosUmidade.data,
			fill: false,
		  }]
		},
		options: {
		  responsive: true,
		  scales: {
			x: {
			  display: true,
			  title: {
				display: true,
				text: 'Data e Hora'
			  }
			},
			y: {
			  display: true,
			  title: {
				display: true,
				text: 'Umidade (%)'
			  }
			}
		  }
		}
	  });
	
	  mudaTemperatura();
	  mudaUmidade();
	
	  setInterval(() => {
		buscarDadosEMostrarGraficos(obterIdDoArmazemDaURL());
	  }, 4000);
	}
	
	function exibirAlerta(mensagem, cor) {
		const alertContainer = document.getElementById('alert-container');
		alertContainer.innerHTML = ''; 
		const alert = document.createElement('div');
		alert.className = `alert alert-${cor}`;
		alert.textContent = mensagem;
		alert.onclick = () => alert.remove(); 
		alertContainer.appendChild(alert);
	}
	
	function verificaCondicoesEExibeAlerta(temperatura, umidade) {
		if (temperatura >= 25 || temperatura <= 18 || umidade <= 10 || umidade >= 14) {
			exibirAlerta('Alerta: Condição Crítica!', 'red');
		} else if (temperatura >= 23 || temperatura <= 19 || umidade >= 11 || umidade <= 13) {
			exibirAlerta('Atenção: Condição de Aviso!', 'yellow');
		}
	}
	
	function mudaTemperatura() {
		const tamanhoListaTemperatura = dadosTemperatura.data.length;
		const temperaturaAtual = dadosTemperatura.data[tamanhoListaTemperatura - 1];
		document.getElementById('mostra_temperaturaAtual').innerHTML = temperaturaAtual + 'ºC';
		
		const umidadeAtual = dadosUmidade.data[dadosUmidade.data.length - 1];
		verificaCondicoesEExibeAlerta(temperaturaAtual, umidadeAtual);
	}
	
	function mudaUmidade() {
		const tamanhoListaUmidade = dadosUmidade.data.length;
		const umidadeAtual = dadosUmidade.data[tamanhoListaUmidade - 1];
		document.getElementById('mostra_umidade').innerHTML = umidadeAtual + '%';
		
		const temperaturaAtual = dadosTemperatura.data[dadosTemperatura.data.length - 1];
		verificaCondicoesEExibeAlerta(temperaturaAtual, umidadeAtual);
	}
	
	function obterIdDoArmazemDaURL() {
	  const parametrosURL = new URLSearchParams(window.location.search);
	  return parametrosURL.get('armazemId');
	}
	
	window.onload = function() {
	  const idDoArmazem = obterIdDoArmazemDaURL();
	  if (idDoArmazem) {
		buscarDadosEMostrarGraficos(idDoArmazem);
	  } else {
		console.error("ID do armazém não encontrado na URL.");
	  }
	};
	</script>
	